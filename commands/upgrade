#!/bin/bash

set -e
. "$GRPL_WORKDIR/utils/common"
install_prerequisite

cli_upgrade_help() {
  cli_name=${0##*/}
  echo "
$cli_name
the grapple cli
Version: $(cat $GRPL_WORKDIR/VERSION)
https://grapple-solutions.com/

Usage: $cli_name [command]

Commands:
  *         Help
" >&2
  exit 0
}

[ "$1" = "help" ] || [ "$1" = "h" ] && cli_upgrade_help

current="$(cat $GRPL_WORKDIR/VERSION)"
new=$(brew outdated --json grapple-cli | grep -o '"current_version": "[^"]*"' | sed 's/"current_version": "//;s/"$//')

if $current == $new; then 
  status_log $TYPE_INFO "grapple-cli $new already installed"
  echo "grapple-cli $new already installed"
  exit 0
fi

if gum spin --title "Upgrading grapple-cli" --show-output -- brew upgrade grapple-cli; then
  $current > $GRPL_WORKDIR/VERSION
fi



status_log $TYPE_INFO "grapple-cli is upgraded to $new"
echo "ran upgrade, grapple-cli is upgraded to $new"